version: 0.1
component: build
timeoutInSeconds: 10000
shell: bash
failImmediatelyOnError: true

env:
  variables:
    DEPLOYMENT_ENV: "stage"
    REGISTRY: "sg.ocir.io/ax3rpuvlqpux/devops-repo"
    IMAGE_NAME: "myapp"
    IMAGE_CREATED_BY: "OCIDevOps"
  exportedVariables:
    - BUILDRUN_HASH
    - DOCKER_TAG

inputArtifacts:
  # No input artifacts needed in this build
  - name: none
    type: GENERIC_ARTIFACT
    artifactId: "none"
    registryId: "none"
    path: "none"
    version: "none"
    location: "none"

steps:
  - type: Command
    name: "Docker Build and Tag"
    shell: bash
    timeoutInSeconds: 3000
    failImmediatelyOnError: true
    command: |
      echo "Starting Docker build step..."

      # Extract 7-char hash from Build Run ID
      export BUILDRUN_HASH=$(echo "${OCI_BUILD_RUN_ID}" | rev | cut -c 1-7)
      echo "BUILDRUN_HASH: ${BUILDRUN_HASH}"

      # Build versioned image tag
      export IMAGE_VERSION="${BUILDRUN_HASH}-${IMAGE_CREATED_BY}"
      export DOCKER_TAG="${REGISTRY}/${IMAGE_NAME}:${IMAGE_VERSION}"
      echo "DOCKER_TAG: ${DOCKER_TAG}"

      # Build Docker image
      docker build -t ${DOCKER_TAG} .

      # Tag as latest
      docker tag ${DOCKER_TAG} ${REGISTRY}/${IMAGE_NAME}:latest
      echo "Docker image built: ${DOCKER_TAG} and tagged as latest"

    onFailure:
      - type: Command
        command: |
          echo "Docker build step failed!"
          exit 1
        timeoutInSeconds: 400

outputArtifacts:
  - name: dockerImage
    type: DOCKER_IMAGE
    location: ${DOCKER_TAG}
