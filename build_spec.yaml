version: 0.1
component: build
timeoutInSeconds: 3600
runAs: root
shell: bash

env:
  variables:
    DEPLOYMENT_ENV: "stage"
    IMAGE_NAME: "myapp"
    IMAGE_CREATED_BY: "OCIDevOps"
    REGISTRY: "sin.ocir.io/ax3rpuvlqpux/devops-repo"   # âœ… Correct repo path (no extra folder)
  exportedVariables:
    - BUILDRUN_HASH
    - DOCKER_TAG

steps:
  - type: Command
    name: "Docker Build and Tag"
    timeoutInSeconds: 3000
    failImmediatelyOnError: true
    command: |
      echo "Starting Docker build step..."

      # Extract short hash from build run ID
      export BUILDRUN_HASH=$(echo "${OCI_BUILD_RUN_ID}" | rev | cut -c 1-7)
      echo "BUILDRUN_HASH: ${BUILDRUN_HASH}"

      # Create version tag
      export IMAGE_VERSION="${BUILDRUN_HASH}-${IMAGE_CREATED_BY}"
      export DOCKER_TAG="${REGISTRY}/${IMAGE_NAME}:${IMAGE_VERSION}"

      echo "Image version will be: ${IMAGE_VERSION}"
      echo "Full Image Tag: ${DOCKER_TAG}"

      # Build the Docker image
      docker build -t ${DOCKER_TAG} .

      # Also tag as latest
      docker tag ${DOCKER_TAG} ${REGISTRY}/${IMAGE_NAME}:latest
      echo "Image also tagged as: ${REGISTRY}/${IMAGE_NAME}:latest"

outputArtifacts:
  - name: dockerImage
    type: DOCKER_IMAGE
    location: ${DOCKER_TAG}
