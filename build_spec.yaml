version: 0.1
component: build
timeoutInSeconds: 3600
runAs: root
shell: bash

env:
  variables:
    DEPLOYMENT_ENV: "stage"
    # Registry points to the repository only, image name added in Docker tag
    REGISTRY: "sg.ocir.io/ax3rpuvlqpux/devops-repo"
    IMAGE_NAME: "myapp"
    IMAGE_CREATED_BY: "OCIDevOps"

  exportedVariables:
    - BUILDRUN_HASH
    - DOCKER_TAG

steps:
  - type: Command
    name: "Docker Build and Tag"
    timeoutInSeconds: 3000
    command: |
      echo "Starting Docker build step..."

      # Extract 7-char hash from Build Run ID
      export BUILDRUN_HASH=$(echo "${OCI_BUILD_RUN_ID}" | rev | cut -c 1-7)
      echo "BUILDRUN_HASH: ${BUILDRUN_HASH}"

      # Build versioned image tag
      export IMAGE_VERSION="${BUILDRUN_HASH}-${IMAGE_CREATED_BY}"
      export DOCKER_TAG="${REGISTRY}/${IMAGE_NAME}:${IMAGE_VERSION}"
      echo "DOCKER_TAG: ${DOCKER_TAG}"

      # Build Docker image
      docker build -t ${DOCKER_TAG} .

      # Optional: tag as latest
      docker tag ${DOCKER_TAG} ${REGISTRY}/${IMAGE_NAME}:latest
      echo "Docker image built and tagged as latest"

outputArtifacts:
  - name: docker-image            # Must match Deliver Artifact stage result artifact name
    type: DOCKER_IMAGE
    location: ${DOCKER_TAG}      # Build runner will pass the versioned tag
